description "Starphleet autodeploy repositories based on orders"

emits startphleet_serve

instance $order

script

  CHANGE=$(phleet monitor check "${repository}" "${order}.git" | grep CODE100)
  cd "${order}.git"
  if [ "${CHANGE}" ]; then
   echo ordered repository updated
   phleet monitor update "${repository}" "${order}.git"
   CURRENT_SHA=`git log -n 1 --no-merges --pretty=format:%h`
   docker build -t "${CURRENT_SHA}" .
  fi
  CURRENT_SHA=`git log -n 1 --no-merges --pretty=format:%h`
  echo ${order} at ${CURRENT_SHA}
  SERVICE="${order}-${CURRENT_SHA}"
  #and fire off a start every time, this is a keepalive via upstart
  #the container is named from the order and the sha, since you can order the
  #same service multiple times
  initctl start starphleet_serve service="${SERVICE}" image="${CURRENT_SHA}"

end script
