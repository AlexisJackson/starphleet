description "Keep and eye on NGINX and make sure that it has the right state"

setuid admiral

start on starphleet_pulse
stop on stopping starphleet

script
  #this is to allow our buddy grep to be used
  set +e
  date
  source /var/starphleet/.headquarters
  for container in $(generate containers ${CURRENT_CONTAINERS}/*.json)
  do
    IN_THERE=$(grep ${container} "${NGINX_CONF}/servers.conf")
    if [ "${IN_THERE}" ]; then
      echo -n
    else
      echo regenerating nginx configuration
      generate servers ${CURRENT_CONTAINERS}/*.json > \
      "${NGINX_CONF}/servers.conf"
      sudo reload starphleet_nginx
      exit 0
    fi
  done
end script
