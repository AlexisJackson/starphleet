description "Starphleet monitor all ordered services for autodeployment"

start on started starphleet
stop on stopping starphleet

respawn

script
  while [ 1 ]
  do
    set +e
    source `which tools`
    sleep "${STARPHLEET_PULSE}"

    get_CURRENT_SHA "${HEADQUARTERS_LOCAL}"
    latest_AUTHOR "${HEADQUARTERS_LOCAL}"
    ORDERS_SHA="${CURRENT_SHA}"

    #Clean up Removed Orders
    for ORDER_FILE in $(find "${CURRENT_ORDERS}" -type l -iname ".starphleetstatus")
    do
      ORDER_FILE="${ORDER_FILE%/*}"
      ORDER_FILE="${ORDER_FILE##*/}"
      if [[ $(\ls "${HEADQUARTERS_LOCAL}" | grep -ce "${ORDER_FILE}$") -eq 0 ]]; then
        #Clean up published Nginx Configs
        [ -f "${NGINX_CONF}/upstream/$(urlencode \"/${ORDER_FILE}/\").conf" ] && rm "${NGINX_CONF}/upstream/$(urlencode \"/${ORDER_FILE}/\").conf"
        [ -f "${NGINX_CONF}/published/$(urlencode \"/${ORDER_FILE}/\").conf" ] && rm "${NGINX_CONF}/published/$(urlencode \"/${ORDER_FILE}/\").conf"
        [ -f "${NGINX_CONF}/published_bare/$(urlencode \"/${ORDER_FILE}/\").conf" ] && rm "${NGINX_CONF}/published_bare/$(urlencode \"/${ORDER_FILE}/\").conf"

        [ -d "${CURRENT_ORDERS}/${ORDER_FILE}" ] && rm -rf "${CURRENT_ORDERS}/${ORDER_FILE}"
      fi
    done


    #track the publish ports
    unset PUBLISH_PORTS
    declare -a PUBLISH_PORTS

    #auto deploy each ordered service, really need to use grep here
    #find doesn't work out on that / pattern
    for order in $(find "${HEADQUARTERS_LOCAL}" | grep '/orders$')
    do
      trace -----------------------
      info checking ${order}
      #reset variables
      source /etc/starphleet
      ORDER=$(echo "${order}" | sed -e 's[/orders$[[' | sed -e "s[${HEADQUARTERS_LOCAL}/\?[[")
      #make a place for the orders to be managed while running, this is separate
      #from the order files in the headquarters
      CURRENT_ORDER="${CURRENT_ORDERS}/${ORDER}"
      mkdir -p "${CURRENT_ORDER}"
      #use git to determing if the orders have changed since the last publish
      if [ -f "${CURRENT_ORDER}/.orders_sha" ]; then
        DEPLOYED_ORDERS_SHA=$(cat "${CURRENT_ORDER}/.orders_sha")
        get_VERSION_DIFF ${HEADQUARTERS_LOCAL} ${ORDERS_SHA} ${DEPLOYED_ORDERS_SHA} $(dirname "${order}")
        if [ -n "${VERSION_DIFF}" ]; then
          ORDERS_DIFF="Updated orders"
        else
          ORDERS_DIFF="NONE"
        fi
      else
        ORDERS_DIFF="New orders"
      fi
      # k, so.  in this scope we don't actually care about the betas BUT
      # we do want it to be an associative array... if we DO NOT explicitly
      # make it associative it will implicitly be created as indexed, if you
      # try to index an indexed (non associative array) with an index like
      # pants-3322 bash will try to perform the arithmetic operation that
      # statement seems to indicate (since indexed arrays expect numeric indicies)
      # pants - 3322 will result in an invalid index and blow chunks.
      # thus we explicitly declare BETAS
      declare -A BETAS
      #run the order as a whole script with the autodeploy function defined above
      #this lets folks get creative in orders files as needed
      unset SERVICE_GIT_URL
      run_orders "${order}"
      unset DEPLOY_REASON
      [ "${ORDERS_DIFF}" != "NONE" ] && DEPLOY_REASON="${ORDERS_DIFF}"
      #check if this publish port is a duplicate, halting the install of this
      #order if so, first one wins
      if [ "${PUBLISH_PORT}" != "0" ]; then
        warn "${ORDER}" is requesting a host port "${PUBLISH_PORT}"
        if [ -n "${PUBLISH_PORTS["${PUBLISH_PORT}"]}" ]; then
          error ${ORDER} attempted to duplicate port ${PUBLISH_PORT}
          echo ${ORDER} attempted to duplicate port ${PUBLISH_PORT} | mail -s 'Headquarters Error' "${AUTHOR}"
          #clear this guard to prevent a deploy
          SERVICE_GIT_URL=""
        fi
        PUBLISH_PORTS["${PUBLISH_PORT}"]="1"
      fi
      #if there is a service repo, pull and synch it
      if [ -n "${SERVICE_GIT_URL}" ]; then
        LOCAL="${HEADQUARTERS_LOCAL}/${ORDER}/git"
        #if there is new code in the remote for a service -- or if the orders have
        #changed, it is time to start
        if dev_mode ; then
          warn Dev Mode Detected
          ENCODED_ORDER=$(urlencode "${ORDER}")
          SERVICE_NAME=$(echo "${ENCODED_ORDER}")
          ###
          # Modified Dev Mode
          ###
          #
          # Due to issues with large git containers puking while trying to checkout
          # to the vmware HOST os we've adjusted and made the first container build
          # checkout git locally in the container.. then, rsync the git repo to
          # vmware's shared directory.  This seems to be more resillient to this
          # pesky bug.

          # Below, we now listen for changes in the checked out git repos and
          # deploy new containers based on these changes.

          # We also use datestamps for container deployments instead of shas
          DATE_TIME=$(date +d%y%m%d-d%H%M%S)
          # This file is created each run for a container.  We use this files
          # modified time to determine if anything 'new' has been created/changed
          # since our last deployment of a container
          LAST_RUN_FILE="/tmp/.${SERVICE_NAME}-starphleet_last_run"

          # If we detect that this order was already run once and
          # this container has a repo directory
          # TODO: Find out if we have a DEV DIR variable available here somewhere
          # TODO: Figure out the proper path variable to the container
          if [ -d "/hosthome/starphleet_dev/${ORDER}" ] && [ -f "${LAST_RUN_FILE}" ]; then
            # Work around vmware hgfs sync issues on the host OS
            #   - Basically for now we need to git sync to a local directory
            #     in the container and then move that directory into the git
            #     repo of the host ship.. which then gets sync'd upstream
            #     to the host OS.  Unfortunately, running git on large
            #     repos against the sync-dir intermitantly crashes git
            #
            #     Here we are seeing if the rsync dir still exists which implies
            #     it hasn't finished moving to the host OS yet
            if [ ! -d "/home/admiral/tmp/${ORDER}" ]; then
              ####
              # File Change Detection
              ####
              # Define a temp file to check for changed files
              CHANGED_FILES_FILE="/tmp/${ORDER}.starphleet.newfiles"
              # Then spitout any files that have changed since we last ran
              find "/hosthome/starphleet_dev/${ORDER}" -newer "${LAST_RUN_FILE}" | grep -v .git > "${CHANGED_FILES_FILE}"
              # Remember what changed so we can be nice and log it
              DEPLOY_REASON=$(cat ${CHANGED_FILES_FILE})
              rm ${CHANGED_FILES_FILE}
              ####
              # Not running detection
              ####
              # In this section - in dev mode - if a container isn't running that should
              # be we always tried to start a new one.  The normal starphleet behavior
              # will only serve up an order once per order/sha change.  We instead will
              # restart failing containers forever
              RUNNING=$(lxc-ls -f | grep RUNNING | grep --extended-regexp -e "^${ENCODED_ORDER}-([a-f0-9]){7}-([a-f0-9]){7}")
              # If nothing returned - nothing is running so we should deploy again
              [ -z "${RUNNING}" ] && DEPLOY_REASON="NOT RUNNING"
              unset RUNNING
            fi
          fi
          if [ ! -f "${LAST_RUN_FILE}" ]  || [ -n "${DEPLOY_REASON}" ]; then
            # Now that we are deploying - make sure we unset our reason
            # for next pass
            unset DEPLOY_REASON
            # Flag that this has been deployed
            touch "${LAST_RUN_FILE}"
            # Now deploy
            warn Dev Mode Deployment: "${DEPLOY_REASON}"
            start --no-wait starphleet_serve_order name="${SERVICE_NAME}-${DATE_TIME}" order="${ORDER}"
          fi
          # If we are in dev mode then there is never a good enough reason in
          # ${DEPLOY_REASON} that we'd want a container with a sha so we
          # force the rest of the code to be skipped
          continue
        else
          #resynchronize to autodeploy repo, this is the primary case
          starphleet-git-synch "${SERVICE_GIT_URL}" "${LOCAL}" && DEPLOY_REASON="Updated service"
        fi
      fi
      #if there is any reason to start a container -- well, go to it
      if [ -n "${DEPLOY_REASON}" ]; then
        warn "${DEPLOY_REASON}"
        echo ${ORDERS_SHA} > "${CURRENT_ORDER}/.orders_sha"
        if [ -d "${LOCAL}" ]; then
          get_CURRENT_SHA "${LOCAL}"
          SERVICE_SHA="${CURRENT_SHA}"
        fi
        ENCODED_ORDER=$(urlencode "${ORDER}")
        #sha for both the service and the orders asking for it, changing either
        #of these starts up a new container that will run in parallel with prior
        #versions
        SERVICE_NAME=$(echo "${ENCODED_ORDER}-${ORDERS_SHA}-${SERVICE_SHA}")
        #this is done with no-wait since upstart will prevent duplicate starts
        start --no-wait starphleet_serve_order name="${SERVICE_NAME}" order="${ORDER}"
      fi
    done
  done
end script
