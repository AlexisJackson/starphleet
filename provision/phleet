#!/usr/bin/env bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

BLUE_BOLD=$(tput setaf 4; tput bold)
NORMAL=$(tput sgr0)

function announce() {
  echo -e "$BLUE_BOLD$*$NORMAL"
}

stop starphleet

#headquarters will go here
mkdir -p /var/starphleet
chmod 0777 /var/starphleet
mkdir -p /var/starphleet/current_orders
mkdir -p /var/starphleet/private_keys

#put in the system overlay, gets all the files in place
cp -R /starphleet/overlay/* /

#starphleet control scripts from the mount shared source
cd /starphleet
npm install -g coffee-script
npm install -g
cd /

#someone has to be the admiral
ADMIRAL="admiral"
ADMIRAL_HOME="/home/admiral"
useradd ${ADMIRAL} -m -d ${ADMIRAL_HOME}
adduser ${ADMIRAL} sudo
chown -R ${ADMIRAL} /var/starphleet*

#this is our base container, it is a time saving step as the compilers
#will generally be needed, but are a lot larger install than say nodejs
BASE_BUILD=${TMPDIR-/tmp}/basebuild
cat << EOF > ${BASE_BUILD}
  apt-get -y update
  apt-get -y install --force-yes git curl
  apt-get -y install --force-yes python g++ make
  apt-get -y install --force-yes python-software-properties
  apt-get -y install --force-yes software-properties-common
EOF
trap 'rm -rf ${BASE_BUILD}' EXIT

#base ubuntu LXC image, get this on before we start anything
BASE_CONTAINER_NAME="starphleet-base"
if lxc-ls | grep "${BASE_CONTAINER_NAME}$" > /dev/null; then
  echo -n
else
  lxc-create -n "${BASE_CONTAINER_NAME}" -t ubuntu
  starphleet-wait-network > "/var/lib/lxc/starphleet-base/rootfs/.block"
  cat "${BASE_BUILD}" > "/var/lib/lxc/starphleet-base/rootfs/.build"
  lxc-start --name ${BASE_CONTAINER_NAME} -d
  lxc-wait --name ${BASE_CONTAINER_NAME} --state RUNNING --timeout 30
  lxc-attach --name ${BASE_CONTAINER_NAME} -- bash /.block
  lxc-attach --name ${BASE_CONTAINER_NAME} -- bash /.build
  lxc-stop --name ${BASE_CONTAINER_NAME}
  lxc-wait --name ${BASE_CONTAINER_NAME} --state STOPPED --timeout 30
fi

#good to go, start the phleet
start starphleet

announce
announce *Welcome to Starphleet*
