#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

BLUE_BOLD=$(tput setaf 4; tput bold)
GREEN=$(tput setaf 2; tput bold)
NORMAL=$(tput sgr0)

function announce() {
  echo -e "$BLUE_BOLD$*$NORMAL"
}

function info() {
  echo -e "$GREEN$*$NORMAL" 1>&2
}

stop starphleet


#starphleet lives here
mkdir -p /var/starphleet/diagnostic
chmod -R 0777 /var/starphleet
cp /starphleet/scripts/tools /var/starphleet/tools

#put in the system overlay, gets all the files in place
rm /etc/init/starphleet*
cp -R /starphleet/overlay/* /

#someone has to be the admiral
ADMIRAL="admiral"
ADMIRAL_HOME="/home/admiral"
useradd ${ADMIRAL} -m -d ${ADMIRAL_HOME}
adduser ${ADMIRAL} sudo
chown -R ${ADMIRAL}:${ADMIRAL} /var/starphleet

# the target user should always have an ssh folder
ADMIRALSSH="${ADMIRAL_HOME}/.ssh"
if [ ! -d "${ADMIRALSSH}" ]; then
  echo Make admiral ssh folder at ${ADMIRALSSH}
  mkdir ${ADMIRALSSH}
fi
chmod 700 ${ADMIRALSSH}
chown ${ADMIRAL}:${ADMIRAL} ${ADMIRALSSH}
info admiral created

#transfer private keys
info checking for private keys in /starphleet/private_keys
if [ -d /starphleet/private_keys ]; then
  test -d /var/starphleet/private_keys || mkdir -p /var/starphleet/private_keys
  cp /starphleet/private_keys/* /var/starphleet/private_keys/
fi

#starphleet control scripts from the mount shared source
cd /starphleet
npm install -g coffee-script
npm install -g
cd /

#base ubuntu LXC image, get this on before we start anything
BASE_CONTAINER_NAME="starphleet-base"
if lxc-ls | grep "${BASE_CONTAINER_NAME}$" > /dev/null; then
  date > /var/starphleet/diagnostic/starphleet-base
  info base container exists
else
  echo '' > var/starphleet/diagnostic/starphleet-base
  lxc-create -n "${BASE_CONTAINER_NAME}" -t ubuntu
  starphleet-wait-network > "/var/lib/lxc/starphleet-base/rootfs/.block"
  starphleet-base-script > "/var/lib/lxc/starphleet-base/rootfs/.build"
  lxc-start --name ${BASE_CONTAINER_NAME} -d
  starphleet-wait-lxc ${CONTAINER_NAME} RUNNING
  lxc-attach --name ${BASE_CONTAINER_NAME} -- bash /.block
  lxc-attach --name ${BASE_CONTAINER_NAME} -- bash /.build
  lxc-stop --name ${BASE_CONTAINER_NAME}
  starphleet-wait-lxc ${CONTAINER_NAME} STOPPED
  date > /var/starphleet/diagnostic/starphleet-base
  info base container built
fi

#good to go, start the phleet
start starphleet

announce *Welcome to Starphleet*
