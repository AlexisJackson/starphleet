#!/usr/bin/env bash
### Usage:
###    starphleet-install
### --help
###
### This will get starphleet on a base machine
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source ${DIR}/tools
help=$(grep "^### " "$0" | cut -c 5-)
eval "$(${DIR}/docopts -h "$help" -V "$version" : "$@")"


#flush out caches, I know, I know -- but really if you don't do this
#Linux would rather swap than let go
sync && echo 3 | sudo tee /proc/sys/vm/drop_caches

#this is a provisioning script for the base system/host/vm
#run as root, with the starphleet source tree at /starphleet

#role account for folks acting as the admiral, do this really early
#as it will provide the home directory
make_admiral

mkdir -p "${LXC_ROOT}"
chmod 755 "${LXC_ROOT}"

#yep -- international, no fooling
echo "GMT" > /etc/timezone
dpkg-reconfigure -f noninteractive tzdata

hostname "${SHIP}"
echo "${SHIP}" > /etc/hostname
echo "127.0.0.1 ${SHIP} localhost" > /etc/hosts

#put in the system overlay, gets all the files in place
#for the starphleet jobs
rm -f /etc/init/starphleet*
cp -R ${DIR}/../overlay/* /
cp -R ${DIR}/../nginx/* /var/starphleet/nginx/

#packages
debconf-set-selections <<< "postfix postfix/mailname string '${SHIP}'"
debconf-set-selections <<< "postfix postfix/main_mailer_type string 'Internet Site'"
apt-get -y install --force-yes software-properties-common
add-apt-repository -y ppa:chris-lea/node.js
apt-get -y update
apt-get -y upgrade
apt-get -y install --force-yes $(cat "${DIR}/packages")

pushd /var/starphleet/nginx
set -e
make
set +e
popd

#we will be using bash. period
rm /bin/sh
ln /bin/bash /bin/sh


#starphleet lives here
[ -d ${STARPHLEET_ROOT} ] || mkdir -p ${STARPHLEET_ROOT}
[ -d ${STARPHLEET_TMP} ] || mkdir -p ${STARPHLEET_TMP}
chmod 755 ${STARPHLEET_ROOT}
[ -d ${STARPHLEET_ROOT}/diagnostic ] || mkdir -p ${STARPHLEET_ROOT}/diagnostic
chmod 755 ${STARPHLEET_ROOT}/diagnostic

#starphleet and all of its scripts
pushd "${DIR}/.."
npm ${NPM_FLAGS} install -g
popd

#make a place for keys
test -d ${PRIVATE_KEYS} || mkdir -p ${PRIVATE_KEYS}
chmod 755 ${PRIVATE_KEYS}
test -d ${PUBLIC_KEYS} || mkdir -p ${PUBLIC_KEYS}
chmod 755 ${PUBLIC_KEYS}
#force install private and public keys from local vagrant image
if find /starphleet/private_keys/* > /dev/null ; then
  [ -d "${PRIVATE_KEYS}" ] && cp /starphleet/private_keys/* "${PRIVATE_KEYS}"
fi
if find /starphleet/public_keys/* > /dev/null ; then
  [ -d "${PUBLIC_KEYS}" ] && cp /starphleet/public_keys/* "${PUBLIC_KEYS}"
fi


#allow passwordless sudoers
cat > ${ROOT}/etc/sudoers <<'EOF'
Defaults	env_reset
Defaults	mail_badpass
Defaults	secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
root	ALL=(ALL:ALL) ALL
%admin ALL=(ALL) ALL
%sudo	ALL=(ALL:ALL) NOPASSWD:ALL
vagrant ALL=NOPASSWD: ALL
Defaults env_keep="sSH_AUTH_SOCK"
Defaults !requiretty
EOF

starphleet-buildpacks

touch /var/starphleet/.system
start starphleet
announce *Welcome to Starphleet*
