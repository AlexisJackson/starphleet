#!/usr/bin/env starphleet-launcher
### Usage:
###    starphleet-nginx-acl-rules
### --help
###
### Generate all ACL Rules for NGINX
###

die_on_error
run_as_root_or_die

#******************************************************************
# Configuration
#******************************************************************

NGINX_CONF=${NGINX_CONF:-/var/starphleet/nginx}
DIR_NGINX_ACL_RULES="${NGINX_CONF}/acl_rules"
DIR_NGINX_PUBLISHED="${NGINX_CONF}/published"

#******************************************************************
# Main
#******************************************************************

# We purge everything each run and start over
[ -d "${DIR_NGINX_ACL_RULES}" ]  && rm -rf "${DIR_NGINX_ACL_RULES}"
rm "${DIR_NGINX_PUBLISHED}"/*.acl 2> /dev/null || true

# Make sure our dirs work
mkdir -p "${DIR_NGINX_ACL_RULES}"
mkdir -p "${DIR_NGINX_PUBLISHED}"

# Go through all Access Control List files (*.acl)
for FILE_ACL_LIST in $(find ${HEADQUARTERS_LOCAL} -type f -name "*.acl"); do
  # Yoink the HQ Path off
  SERVICE=$(echo ${FILE_ACL_LIST#${HEADQUARTERS_LOCAL}/})
  # Yoink the file name for theFILE_ACL_LIST
  SERVICE=$(echo ${SERVICE} | sed -e "s/$(basename ${FILE_ACL_LIST})//")
  # Yoink the trailing slash
  SERVICE=${SERVICE::-1}
  # Readability - pull just the ACL file name without extension
  FILE_ACL_LIST_WITHOUT_EXTENSION=$(basename ${FILE_ACL_LIST})
  FILE_ACL_LIST_WITHOUT_EXTENSION=${FILE_ACL_LIST_WITHOUT_EXTENSION::-4}
  # The file with our rules for this service
  FILE_ACL_RULES_MAP="${DIR_NGINX_ACL_RULES}/${SERVICE}.conf"
  FILE_ACL_RULES_CONF="${DIR_NGINX_PUBLISHED}/${SERVICE}.acl"
  # Create the map file and make the default 0
  echo "  map \$remote_user \$starphleet_acl_${SERVICE}_${FILE_ACL_LIST_WITHOUT_EXTENSION} {" >> "${FILE_ACL_RULES_MAP}"
  echo "   default 0;" >> "${FILE_ACL_RULES_MAP}"
  # Add each user
  for ACL_USERNAME in $(cat "${FILE_ACL_LIST}"); do
    echo "   ${ACL_USERNAME} 1;" >> "${FILE_ACL_RULES_MAP}"
  done
  echo "  }" >> "${FILE_ACL_RULES_MAP}"

  # Now we actually publish the rule for the map
  echo "  if (\$starphleet_acl_${SERVICE}_${FILE_ACL_LIST_WITHOUT_EXTENSION} != 1) {" >> "${FILE_ACL_RULES_CONF}"
  echo "    rewrite ^/${SERVICE}/(.*) /autherror last;" >> "${FILE_ACL_RULES_CONF}"
  echo "  }" >> "${FILE_ACL_RULES_CONF}"
done

starphleet-hup-nginx
