#!/usr/bin/env starphleet-launcher
### Usage:
###    starphleet-nginx-acl-rules
### --help
###
### Generate all ACL Rules for NGINX
###

die_on_error
run_as_root_or_die

#******************************************************************
# Configuration
#******************************************************************

NGINX_CONF=${NGINX_CONF:-/var/starphleet/nginx}
DIR_ACL_RULES="${NGINX_CONF}/acl_rules"
DIR_PUBLISHED="${NGINX_CONF}/published"

[ -d "${DIR_ACL_RULES}" ]  && rm -rf "${DIR_ACL_RULES}"
rm "${NGINX_CONF}"/published/*.acl 2> /dev/null || true

mkdir -p "${DIR_ACL_RULES}"

for FILE_ACL_LIST in $(find ${HEADQUARTERS_LOCAL} -type f -name "*.acl"); do
  # Yoink the HQ Path off
  SERVICE=$(echo ${FILE_ACL_LIST} | perl -ne "s|${HEADQUARTERS_LOCAL}/||;print $1")
  # Yoink the file name for theFILE_ACL_LIST
  SERVICE=$(echo ${SERVICE} | perl -ne "s|/$(basename ${FILE_ACL_LIST})||;print $1")
  # The file with our rules for this service
  FILE_ACL_RULES_MAP="${DIR_ACL_RULES}/${SERVICE}.conf"
  FILE_ACL_RULES_CONF="${DIR_PUBLISHED}/${SERVICE}.acl"
  # Only create one map file per service
  # XXX: Is it an error if orders have more than one acl list?
  if [ ! -f "${FILE_ACL_RULES_MAP}" ]; then
    echo "  map \$remote_user \$starphleet_acl_service_${SERVICE} {" > "${FILE_ACL_RULES_MAP}"
    echo "   default 0;" >> "${FILE_ACL_RULES_MAP}"
    for ACL_USERNAME in $(cat "${FILE_ACL_LIST}"); do
      echo "   ${ACL_USERNAME} 1;" >> "${FILE_ACL_RULES_MAP}"
    done
    echo "  }" >> "${FILE_ACL_RULES_MAP}"
  fi

  echo "  if (\$starphleet_acl_service_${SERVICE} != 1) {" > "${FILE_ACL_RULES_CONF}"
  echo "    rewrite ^/${SERVICE}/(.*) /autherror last;" >> "${FILE_ACL_RULES_CONF}"
  echo "  }" >> "${FILE_ACL_RULES_CONF}"
done

starphleet-hup-nginx
