#!/usr/bin/env starphleet-launcher
### Usage:
###    starphleet-nginx-acl-rules
### --help
###
### Generate all ACL Rules for NGINX
###

die_on_error
run_as_root_or_die

#******************************************************************
# Configuration
#******************************************************************

NGINX_CONF=${NGINX_CONF:-/var/starphleet/nginx}
DIR_NGINX_ACL_RULES="${NGINX_CONF}/acl_rules"
DIR_NGINX_PUBLISHED="${NGINX_CONF}/published"

#******************************************************************
# Main
#******************************************************************

# We purge everything each run and start over
[ -d "${DIR_NGINX_ACL_RULES}" ]  && rm -rf "${DIR_NGINX_ACL_RULES}"
rm "${DIR_NGINX_PUBLISHED}"/*.acl 2> /dev/null || true

# Make sure our dirs work
mkdir -p "${DIR_NGINX_ACL_RULES}"
mkdir -p "${DIR_NGINX_PUBLISHED}"

# Go through all Access Control List files (*.acl)
for FILE_ACL_LIST in $(find ${HEADQUARTERS_LOCAL} -type f -name "*.acl"); do
  # Yoink the HQ Path off
  SERVICE=$(echo ${FILE_ACL_LIST} | perl -ne "s|${HEADQUARTERS_LOCAL}/||;print $1")
  # Yoink the file name for theFILE_ACL_LIST
  SERVICE=$(echo ${SERVICE} | perl -ne "s|/$(basename ${FILE_ACL_LIST})||;print $1")
  # The file with our rules for this service
  FILE_ACL_RULES_MAP="${DIR_NGINX_ACL_RULES}/${SERVICE}.conf"
  FILE_ACL_RULES_CONF="${DIR_NGINX_PUBLISHED}/${SERVICE}.acl"
  # Only create one map file per service
  # XXX: Is it an error if orders have more than one acl list?
  # Only allow one ACL file? (or make this way more complicated)
  if [ ! -f "${FILE_ACL_RULES_MAP}" ]; then
    # Create the map file and make the default 0
    echo "  map \$remote_user \$starphleet_acl_service_${SERVICE} {" > "${FILE_ACL_RULES_MAP}"
    echo "   default 0;" >> "${FILE_ACL_RULES_MAP}"
    # Add each user
    for ACL_USERNAME in $(cat "${FILE_ACL_LIST}"); do
      echo "   ${ACL_USERNAME} 1;" >> "${FILE_ACL_RULES_MAP}"
    done
    echo "  }" >> "${FILE_ACL_RULES_MAP}"
  fi

  # Now we actually publish the rule for the map
  echo "  if (\$starphleet_acl_service_${SERVICE} != 1) {" > "${FILE_ACL_RULES_CONF}"
  echo "    rewrite ^/${SERVICE}/(.*) /autherror last;" >> "${FILE_ACL_RULES_CONF}"
  echo "  }" >> "${FILE_ACL_RULES_CONF}"
done

starphleet-hup-nginx
