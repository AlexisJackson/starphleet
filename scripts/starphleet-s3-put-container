#!/usr/bin/env starphleet-launcher
### Usage:
###    starphleet-s3-put-container <service>
###
### Fuzzy match and make attaching to instances easier
die_on_error
run_as_root_or_die

# For notes
# if [ -n "${BUILD_CONTAINERS}" ] && is_container_storage_on_s3; then
#   starphleet-s3-put-container "${name}" "${S3_PATH_FOR_CONTAINER_STORAGE}" || true
# fi

# Container must be stopped to get a good clone
lxc-stop -n "${service}"
# Clone the container to 'merge' overlayfs with delta
lxc-clone -KH -B dir -o epistream-jwt-d171215-d030728 -n test


# Make sure they pass 'something' to search for
[ -z "${service}" ] && echo Please pass the name of a container && exit 1

# Check and make sure there's at least one running container
CONTAINERS=$(lxc-ls -f | grep STOPPED | grep ${service} | awk '{print $1}')
[ -z "${CONTAINERS}" ] && echo No Stopped Containers && exit 1

# Now figure out which container they want and attach
echo "Start which instance:"
select container in $(lxc-ls -f | grep STOPPED | grep ${service} | awk '{print $1}'); do
  [ ! -z ${container} ] && sudo lxc-start -d -n "${container}"
  break;
done
