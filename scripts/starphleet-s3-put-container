#!/usr/bin/env starphleet-launcher
### Usage:
###    starphleet-s3-put-container <containerName>
###
### Fuzzy match and make attaching to instances easier
die_on_error
run_as_root_or_die

# Because aws cli on our machines is a mixed bag and I really do
# want a modern version.  It's okay if they aren't consistent for
# what we are doing so long as the version isn't 10 years old.
AWS_COMMAND_PATH="/root/.local/bin/aws"
if [ ! -f "${AWS_COMMAND_PATH}" ]; then
  # New pip install wanted libyaml so we'll install that before trying
  # to get the latest AWS cli
  apt-get update -y
  apt-get install -y libyaml-dev
  pip install awscli --upgrade --user
fi

# These envs are required for the AWS command line
export AWS_DEFAULT_REGION="${S3_STORAGE_BUCKET_REGION}"
export AWS_ACCESS_KEY_ID="${S3_STORAGE_AWS_ACCESS_KEY_ID}"
export AWS_SECRET_ACCESS_KEY="${S3_STORAGE_AWS_SECRET_ACCESS_KEY}"

CONTAINER_NAME="${containerName}"
CONTAINER_ROOT=/var/lib/lxc/${CONTAINER_NAME}
if is_container_storage_on_s3 \
  && [ -n "${BUILD_CONTAINERS}" ] \
  && [ -f "${CONTAINER_ROOT}/${CONTAINER_NAME}.tar.gz" ]; then

  S3_PATH_FOR_CONTAINER_STORAGE="s3://${S3_STORAGE_BUCKET_PATH}"
  "${AWS_COMMAND_PATH}" s3 cp "${CONTAINER_ROOT}/${CONTAINER_NAME}.tar.gz" "${S3_PATH_FOR_CONTAINER_STORAGE}"
fi

# Because explicit..
exit 0


   
