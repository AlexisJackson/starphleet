#! /usr/bin/env starphleet-launcher
### Usage: starphleet-verify-overlay [nodetail]
###
###
### Compares starphleet files at their installation location to
### those checked out at /var/starphleet/github

run_as_root_or_die
function green() {
  echo -e  '\E[32m'"$(date +"%x %X - ")\033[1m$*\033[0m"
}
SHOW_DIFF=${SHOW_DIFF-false}
set -u # blow up if we reference an undeclared(set) variable
STARPHLEET_ROOT=/starphleet
[ -d ${STARPHLEET_ROOT} ] || die "no github dir, fix it" 1

# first we go ahead and diff everything from the overlay

echo '********************************************************************'
echo   Validating Overlay
echo '********************************************************************'

for file in $(find ${STARPHLEET_ROOT}/overlay)
do
  [ -d ${file} ] && continue
  FILE_ROOT=${file##${STARPHLEET_ROOT}\/overlay}
  SOURCE=${STARPHLEET_ROOT}/overlay/${FILE_ROOT}
  DESTINATION=${FILE_ROOT}
  DO_THEY_DIFFER="false"
  if ! diff ${SOURCE} ${DESTINATION} > /dev/null 2>&1; then
    DO_THEY_DIFFER="true"
  fi
  if [ "${DO_THEY_DIFFER}" = "true" ]; then
    if [ "${SHOW_DIFF}" = "true" ]; then
      diff ${SOURCE} ${DESTINATION}
    fi
    green "mismatched ${FILE_ROOT}"
  fi
done

echo '********************************************************************'
echo  Now for the scripts dir
echo '********************************************************************'
echo
# then we diff out the executable scripts from the scripts
# dir, which are installed in /usr/bin
for file in $(find ${STARPHLEET_ROOT}/scripts/ ! -name '*.swp' ! -name '*.pyc' ! -name 'starphleet-verify-install')
do
  # don't want to compare bare directories only
  # the files the contain
  [ -d ${file} ] && continue
  FILE_ROOT=${file##${STARPHLEET_ROOT}\/scripts}
  SOURCE=${STARPHLEET_ROOT}/scripts${FILE_ROOT}
  DESTINATION=/usr/bin${FILE_ROOT}
  DO_THEY_DIFFER="false"
  if ! diff ${SOURCE} ${DESTINATION} > /dev/null 2>&1; then
    DO_THEY_DIFFER="true"
  fi
  if [ "${DO_THEY_DIFFER}" = "true" ]; then
    if [ "${SHOW_DIFF}" = "true" ]; then
      diff ${SOURCE} ${DESTINATION}
    fi
    green "mismatched ${FILE_ROOT}"
  fi

  if test -L ${DESTINATION}; then
    echo "${DESTINATION} is still a symlink, this is an artifact fix it"
  fi
done
